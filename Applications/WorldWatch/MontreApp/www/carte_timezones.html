<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Carte fuseaux — Couture Béring (ROTATE FIX) + Antarctique masqué</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { height:100%; margin:0; background:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    svg { width:100vw; height:100vh; display:block; background:#fff; }
    .sphere   { fill:#ffffff; stroke:#222; stroke-width:.6px; }
    .graticule{ fill:none;   stroke:#eaeaea; stroke-width:.4px; }
    .tz       { stroke:#000; stroke-width:.35px; pointer-events:none; }
    .supp     { stroke:#000; stroke-width:.45px; stroke-dasharray:3,3; pointer-events:none; }
    .coast    { fill:none;   stroke:#000; stroke-width:.50px; }
    .borders  { fill:none;   stroke:#444; stroke-width:.35px; }
    .antarctica-fill { fill:#d3d3d3; stroke:none; }
    #panel { position:fixed; left:8px; bottom:8px; background:#fff; border:1px solid #000; border-radius:8px; padding:8px 10px; font-size:12px; max-width:min(520px,90vw); }
    #panel b { font-weight:800; }
    code { background:#f5f5f5; padding:0 4px; border-radius:4px; }
  </style>
</head>
<body>
  <svg id="map" viewBox="0 0 1200 600" preserveAspectRatio="xMidYMid meet"></svg>
  <div id="panel">Chargement…</div>

  <script src="https://unpkg.com/d3@7"></script>
  <script src="https://unpkg.com/topojson-client@3"></script>
  <script>
  (async function(){
    const svg = d3.select("#map");
    const gBase = svg.append("g");
    const gAnt  = svg.append("g");
    const gTZ   = svg.append("g");
    const gSupp = svg.append("g");
    const gCoast= svg.append("g");
    const gBdrs = svg.append("g");
    const width=1200, height=600;
    const panel = document.getElementById('panel');

    // *** IMPORTANT ***: déplacement de la couture via ROTATE (et non center)
    // Central meridian = +11°E => seam à ~169°W (détroit de Béring)
    const projection = d3.geoEquirectangular()
      .rotate([-11, 0])  // <<---- LA MODIF QUI COMPTE
      .fitExtent([[0,0],[width,height]], {type:"Sphere"});
    const path = d3.geoPath(projection);
    const graticule = d3.geoGraticule10();

    gBase.append("path").attr("class","sphere").attr("d", path({type:"Sphere"}));
    gBase.append("path").attr("class","graticule").attr("d", path(graticule));

    const OFFSET_COLORS = {
      '-12:00':'white','-11:00':'lightgrey','-10:00':'grey','-09:30':'darkgrey','-09:00':'white','-08:00':'lightgrey',
      '-07:00':'grey','-06:00':'darkgrey','-05:00':'white','-04:00':'lightgrey','-03:30':'grey','-03:00':'darkgrey',
      '-02:00':'white','-01:00':'lightgrey','+00:00':'grey','+01:00':'darkgrey','+02:00':'white','+03:00':'lightgrey',
      '+03:30':'grey','+04:00':'darkgrey','+04:30':'white','+05:00':'lightgrey','+05:30':'grey','+05:45':'darkgrey',
      '+06:00':'white','+06:30':'lightgrey','+07:00':'grey','+08:00':'darkgrey','+08:45':'white','+09:00':'lightgrey',
      '+09:30':'grey','+10:00':'darkgrey','+10:30':'white','+11:00':'lightgrey','+12:00':'grey','+12:45':'darkgrey',
      '+13:00':'white','+14:00':'lightgrey'
    };

    const RARE_SUPPLEMENTS = [
      { offset: '-09:30', label:'Pacific/Marquesas',  polygon: [[[-141.2,-10.5],[-138.8,-10.5],[-138.8,-8.0],[-141.2,-8.0],[-141.2,-10.5]]] },
      { offset: '+08:45', label:'Australia/Eucla',     polygon: [[[128.8,-33.2],[130.5,-33.2],[130.5,-31.6],[128.8,-31.6],[128.8,-33.2]]] },
      { offset: '+10:30', label:'Australia/Lord_Howe', polygon: [[[159.02,-31.70],[159.22,-31.70],[159.22,-31.30],[159.02,-31.30],[159.02,-31.70]]] },
      { offset: '+12:45', label:'Pacific/Chatham',     polygon: [[[-176.9,-44.5],[-176.1,-44.5],[-176.1,-43.5],[-176.9,-43.5],[-176.9,-44.5]]] }
    ];

    const offsetCache = new Map();
    function getTZID(props){ return props?.TZID || props?.TIME_ZONE || props?.time_zone || props?.tzid || props?.timezone || props?.name || null; }
    function getOffsetMinutes(tzid){
      if (!tzid) return null;
      if (offsetCache.has(tzid)) return offsetCache.get(tzid);
      let mins = null;
      try {
        const now = new Date();
        const tzDate  = new Date(now.toLocaleString('en-US',{ timeZone: tzid }));
        const utcDate = new Date(now.toLocaleString('en-US',{ timeZone:'UTC' }));
        mins = Math.round((tzDate - utcDate)/60000);
      } catch(e) {}
      if (mins === null){
        let m = /UTC\s*([+-])\s*(\d{1,2})(?::?(\d{2}))?/i.exec(tzid);
        if (m){ const s=m[1]==='-'?-1:1, hh=+m[2], mm=m[3]?+m[3]:0; mins = s*(hh*60+mm); }
        if (mins===null){
          m = /GMT\s*([+-])\s*(\d{1,2})/i.exec(tzid);
          if (m){ const s=m[1]==='-'?-1:1, hh=+m[2]; mins = -s*(hh*60); }
        }
      }
      offsetCache.set(tzid, mins);
      return mins;
    }
    function keyFromMinutes(mins){
      if (mins===null || !isFinite(mins)) return null;
      const sign = mins<0 ? '-' : '+';
      const a = Math.abs(mins);
      const H = String(Math.floor(a/60)).padStart(2,'0');
      const M = String(a%60).padStart(2,'0');
      return `${sign}${H}:${M}`;
    }
    function isAntarcticaFeature(f){
      const id = getTZID(f.properties||{}) || '';
      // Ne considérer que les TZID antarctiques explicites
      return /^Antarctica\//.test(id);
    }

    async function fetchLocalThenRemote(localUrl, remoteUrl){
      try{
        const r = await fetch(localUrl);
        if (!r.ok) throw new Error('local '+r.status);
        return await r.json();
      }catch(e){
        const r2 = await fetch(remoteUrl, {mode:"cors"});
        if (!r2.ok) throw new Error('remote '+r2.status);
        return await r2.json();
      }
    }

    try {
      const tz = await fetchLocalThenRemote(
        "./ne_10m_time_zones.geojson",
        "https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_time_zones.geojson"
      );
      const world = await fetchLocalThenRemote(
        "./countries-50m.json",
        "https://unpkg.com/world-atlas@2/countries-50m.json"
      );

      const features = Array.isArray(tz.features) ? tz.features : [];

      // Fuseaux hors Antarctique
      const seenOffsets = new Set();
      const tzFiltered = features.filter(f => !isAntarcticaFeature(f));
      gTZ.selectAll("path.tz")
        .data(tzFiltered)
        .join("path")
          .attr("class","tz")
          .attr("d", d => d3.geoPath(projection)(d))
          .attr("fill", d => {
            const id = getTZID(d.properties||{});
            const mins = getOffsetMinutes(id);
            const key  = keyFromMinutes(mins) || '+00:00';
            seenOffsets.add(key);
            return OFFSET_COLORS[key] || 'lightgrey';
          })
        .append("title")
          .text(d => (d.properties && (d.properties.TZID || d.properties.TIME_ZONE || d.properties.tzid || d.properties.timezone)) || "TZ");

      // Remplissage Antarctique (clip lat <= -60°)
      const land = topojson.feature(world, world.objects.land);
      const cap = d3.geoCircle().center([0,-90]).radius(30)();
      svg.append('clipPath').attr('id','clip-antarctica')
        .append('path').attr('d', d3.geoPath(projection)(cap));
      gAnt.append("path")
        .attr("class","antarctica-fill")
        .attr("d", d3.geoPath(projection)(land))
        .attr("clip-path", "url(#clip-antarctica)");

      // Ensure Antarctica is on top of everything
      svg.node().appendChild(gAnt.node());

      // Suppléments offsets rares si absents
      let added = [];
      for (const s of RARE_SUPPLEMENTS){
        if (!seenOffsets.has(s.offset)){
          const color = OFFSET_COLORS[s.offset] || 'lightgrey';
          const feat = { type:'Feature', properties:{offset:s.offset,label:s.label},
            geometry:{ type:'Polygon', coordinates: s.polygon } };
          gSupp.append("path")
            .datum(feat)
            .attr("class","supp")
            .attr("d", d => d3.geoPath(projection)(d))
            .attr("fill", color)
            .append("title").text(`${s.label} (${s.offset}) — supplément`);
          added.push(s.offset);
        }
      }

      // Côtes & frontières
      const borders = topojson.mesh(world, world.objects.countries, (a,b)=>a!==b);
      gCoast.append("path").attr("class","coast").attr("d", d3.geoPath(projection)(land));
      gBdrs.append("path").attr("class","borders").attr("d", d3.geoPath(projection)(borders));

      panel.innerHTML = "✅ Couture déplacée via <code>rotate([-11,0])</code> → coupure ≈ 169°O (détroit de Béring). "
        + "Antarctique masqué (rempli en gris).";

    } catch (e) {
      panel.innerHTML = "⚠️ Chargement bloqué. Place <code>ne_10m_time_zones.geojson</code> et <code>countries-50m.json</code> dans le même dossier que ce fichier.";
      try {
        const world = await fetch("./countries-50m.json").then(r=>r.json());
        const land = topojson.feature(world, world.objects.land);
        const borders = topojson.mesh(world, world.objects.countries, (a,b)=>a!==b);
        const proj = d3.geoEquirectangular().rotate([-11,0]).fitExtent([[0,0],[1200,600]], {type:"Sphere"});
        gCoast.append("path").attr("class","coast").attr("d", d3.geoPath(proj)(land));
        gBdrs.append("path").attr("class","borders").attr("d", d3.geoPath(proj)(borders));
      } catch {}
    }
  })();
  </script>

  
</body>
</html>
